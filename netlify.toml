[build]
  base = "frontend"
  command = "cd ../cryptic-cabin-bulk-data && npm install && node build.js && cd ../frontend && npm run build"

[[plugins]]
  package = "@netlify/plugin-nextjs"

[build.environment]
  NODE_VERSION = "20"

# Bulk Data Refresh - Every 15 minutes via Netlify Blobs (no rebuild needed!)
# Scryfall data cached for 24h, only Shopify fetched each run (~20s)
[functions."bulk-data-refresh"]
  schedule = "*/15 * * * *"

# Metafield Sync - Twice daily, sync Scryfall data to Shopify metafields
# Runs at 6:30 AM and 6:30 PM UTC
[functions."sync-metafields"]
  schedule = "30 6,18 * * *"

# Metafield Backfill - Daily safety net for products missing Scryfall data
# Runs at 7:00 AM UTC (after the 6:30 sync), does live Scryfall lookups
# for any products without oracle_id. Resumes from cursor across runs.
[functions."sync-metafields-backfill"]
  schedule = "0 7 * * *"

# Shopify Inventory Webhook - Real-time stock updates
[[redirects]]
  from = "/api/shopify-inventory-webhook"
  to = "/.netlify/functions/shopify-inventory-webhook"
  status = 200

# Shopify Product Webhook - Lightweight Scryfall enrichment on create/update
[[redirects]]
  from = "/api/shopify-product-webhook"
  to = "/.netlify/functions/shopify-product-webhook"
  status = 200

# Metafield Backfill - One-off enrichment for existing products missing Scryfall data
# Trigger manually: POST /api/sync-metafields-backfill
# Resumes from cursor on each run; handles 300k+ products across multiple invocations
[[redirects]]
  from = "/api/sync-metafields-backfill"
  to = "/.netlify/functions/sync-metafields-backfill"
  status = 200

# Bulk Data API - CORS headers for JSON files
[[headers]]
  for = "/bulk-data/*"
  [headers.values]
    Access-Control-Allow-Origin = "*"
    Cache-Control = "public, max-age=3600"

# Collection filter JS - CORS + caching for Shopify theme to load cross-origin
[[headers]]
  for = "/js/*"
  [headers.values]
    Access-Control-Allow-Origin = "*"
    Cache-Control = "public, max-age=300"

# Game Data API - Latest sets, popular cards for hero banners
[[redirects]]
  from = "/api/game-data"
  to = "/.netlify/functions/game-data"
  status = 200

# Bulk Data API - Endpoint redirects
# Filtered endpoint must come before the catch-all /api/bulk-data
[[redirects]]
  from = "/api/bulk-data/filtered"
  to = "/.netlify/functions/bulk-data-filtered"
  status = 200

[[redirects]]
  from = "/api/bulk-data/collection"
  to = "/.netlify/functions/bulk-data-collection"
  status = 200

[[redirects]]
  from = "/api/bulk-data"
  to = "/.netlify/functions/bulk-data"
  status = 200

# Cart Import API - For deck builder integrations (Moxfield, Archidekt, etc.)
[[redirects]]
  from = "/api/cart"
  to = "/.netlify/functions/cart"
  status = 200

[[redirects]]
  from = "/api/cart/import"
  to = "/.netlify/functions/cart-import"
  status = 200

[[redirects]]
  from = "/api/cart/lookup"
  to = "/.netlify/functions/cart-lookup"
  status = 200

# Helpdesk API - Support ticket system
# DISABLED: Using Google Apps Script for email forwarding instead of IMAP polling
# [functions."helpdesk-email-poll"]
#   schedule = "*/5 * * * *"

# Helpdesk - Auto-close inactive tickets daily at 6 AM UTC
# DISABLED: Helpdesk functions turned off due to errors
# [functions."helpdesk-auto-close"]
#   schedule = "0 6 * * *"

[[redirects]]
  from = "/api/helpdesk/reply"
  to = "/.netlify/functions/helpdesk-reply"
  status = 200

[[redirects]]
  from = "/api/helpdesk/mark-read"
  to = "/.netlify/functions/helpdesk-mark-read"
  status = 200

[[redirects]]
  from = "/api/helpdesk/webhook/messenger"
  to = "/.netlify/functions/helpdesk-messenger-webhook"
  status = 200

[[redirects]]
  from = "/api/helpdesk/webhook/instagram"
  to = "/.netlify/functions/helpdesk-instagram-webhook"
  status = 200

[[redirects]]
  from = "/api/helpdesk/notify"
  to = "/.netlify/functions/helpdesk-notify"
  status = 200

[[redirects]]
  from = "/api/helpdesk/webhook/email"
  to = "/.netlify/functions/helpdesk-email-webhook"
  status = 200